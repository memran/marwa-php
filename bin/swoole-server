#!/usr/bin/env php
<?php

declare(strict_types=1);

use Marwa\Framework\Http\Swoole\SwooleHttpServer;
use Psr\Http\Message\ResponseInterface;
use Psr\Http\Message\ServerRequestInterface;
use Psr\Http\Message\ResponseFactoryInterface;
use Psr\Http\Server\MiddlewareInterface;
use Psr\Http\Server\RequestHandlerInterface;
use Psr\Log\NullLogger;

// PSR-7/17 factories (example: nyholm/psr7)
use Nyholm\Psr7\Factory\Psr17Factory;

require __DIR__ . '/../vendor/autoload.php';

/**
 * Simple middleware dispatcher implementing PSR-15.
 */
final class MiddlewareDispatcher implements RequestHandlerInterface
{
    /** @var MiddlewareInterface[] */
    private array $stack;

    private RequestHandlerInterface $finalHandler;

    /**
     * @param MiddlewareInterface[] $stack
     */
    public function __construct(array $stack, RequestHandlerInterface $finalHandler)
    {
        $this->stack = array_values($stack);
        $this->finalHandler = $finalHandler;
    }

    public function handle(ServerRequestInterface $request): ResponseInterface
    {
        if (empty($this->stack)) {
            return $this->finalHandler->handle($request);
        }

        /** @var MiddlewareInterface $middleware */
        $middleware = array_shift($this->stack);

        return $middleware->process($request, $this);
    }
}

/**
 * Example final handler â€“ here you plug your Marwa HttpKernel.
 */
final class AppRequestHandler implements RequestHandlerInterface
{
    public function __construct(
        private ResponseFactoryInterface $responseFactory
        // inject Application/HttpKernel/etc as needed
    ) {}

    public function handle(ServerRequestInterface $request): ResponseInterface
    {
        // TODO: delegate to Marwa HttpKernel
        // $response = $this->kernel->handle($request);

        $response = $this->responseFactory->createResponse(200)
            ->withHeader('Content-Type', 'text/plain; charset=utf-8');

        $body = $response->getBody();
        $body->write("Hello from Marwa Swoole PSR-7/15 server\n");

        return $response;
    }
}

// Load config array
$config = require __DIR__ . '/../config/server.php';

// PSR-17 factories
$psr17 = new Psr17Factory();

// Final application handler (plug in your real kernel here)
$appHandler = new AppRequestHandler($psr17);

/**
 * Example middlewares (logging, routing, etc).
 * Implement your own Middlewares and add here.
 *
 * @var MiddlewareInterface[] $middlewares
 */
$middlewares = [
    // new SomeMiddleware(...),
    // new RoutingMiddleware(...),
];

// Compose PSR-15 stack
$dispatcher = new MiddlewareDispatcher($middlewares, $appHandler);

// Logger (use your memran/marwa-logger here if you want)
$logger = new NullLogger();

// Create Swoole HTTP server
$server = new SwooleHttpServer(
    $config,
    $dispatcher,
    $psr17, // ServerRequestFactoryInterface
    $psr17, // StreamFactoryInterface
    $psr17, // UriFactoryInterface
    $psr17, // ResponseFactoryInterface for error responses
    $logger
);

// Run the server
$server->run();
